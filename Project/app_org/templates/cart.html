{% extends 'base.html' %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
    {% include 'navbar.html' %}

    {% for message in get_flashed_messages() %}
        <div class="alert alert-success" role="alert">
            {{ message }}
        </div>
    {% endfor %}

    <main class="cart-container">
        <h1 class="page-title">Seu Carrinho</h1>
        <div class="content">
            <section class="cart-table">
                <table>
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Preço</th>
                            <th>Quantidade</th>
                            <th>Total</th>
                            <th>-</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product, quantity in CartItem %}
                            <tr>
                                <td>
                                    <div class="product">
                                        <img width="150" height="150" src="{{ url_for('static', filename='assets/' + product.image) }}" alt="{{ product.name }}">
                                        <div class="info">
                                            <div class="name">{{ product.name }}</div>
                                            <div class="category">{{ product.category.name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ product.price }}€</td>
                                <td>
                                    <form action="/cart/update/{{ product.id }}" method="POST">
                                        <div class="qty">
                                            <button type="button" class="decrease">-</button>
                                            <input type="number" class="quantity" value="{{ quantity }}" name="quantity" min="1">
                                            <button type="button" class="increase">+</button>
                                            <button type="submit" class="update"><i class="bx bx-check"></i></button>
                                        </div>
                                    </form>
                                </td>
                                <td>{{ (product.price * quantity) | int }}€</td>
                                <td>
                                    <form action="/cart/remove/{{ product.id }}" method="POST">
                                        <button class="remove"><i class="bx bx-x"></i></button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
            <aside class="cart-summary">
                <div class="box">
                    <header>Resumo da Compra</header>
                    <div class="info">
                        <div><span>Subtotal</span><span>{{ total }}€</span></div>
                        <div><span>Portes</span><span>0€</span></div>
                    </div>
                    <footer>
                        <span>Total</span>
                        <span>{{ total }}€</span>
                    </footer>
                </div>
                <form class="botao" action="/cart/checkout" method="POST">
                    <button type="submit">Finalizar Compra</button>
                </form>
            </aside>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const qtyControls = document.querySelectorAll('.qty');

            qtyControls.forEach(control => {
                const decreaseBtn = control.querySelector('.decrease');
                const increaseBtn = control.querySelector('.increase');
                const quantityInput = control.querySelector('.quantity');

                decreaseBtn.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    if (value > 1) {
                        quantityInput.value = value - 1;
                    }
                });

                increaseBtn.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    quantityInput.value = value + 1;
                });

                quantityInput.addEventListener('input', () => {
                    if (quantityInput.value < 1) {
                        quantityInput.value = 1;
                    }
                });
            });
        });
    </script>
{% endblock %}